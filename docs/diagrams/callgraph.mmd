flowchart TD
    %% 顶层入口
    AppDelegate["AppDelegate\n(Classes/AppDelegate.cpp)"]
    GameManager["GameManager\n(Classes/Manager/GameManager.cpp)"]
    ResourceManager["ResourceManager\n(Classes/Core/ResourceManager.*)"]
    ConfigManager["ConfigManager\n(Classes/Manager/ConfigManager.*)"]
    SaveManager["SaveManager\n(Classes/Manager/SaveManager.*)"]

    MainMenu["MainMenuScene\n(Classes/Scenes/MainMenuScene.cpp)"]
    BaseScene["BaseScene\n(Classes/Scenes/BaseScene.cpp)"]
    BattleScene["BattleScene\n(Classes/Scenes/BattleScene.cpp)"]

    UILayer["UILayer\n(Scene UI Layer)"]
    GridMap["GridMap / Pathfinding\n(Classes/Map/*)"]

    Building["Building\n(Classes/Buildings/Building.cpp)"]
    DefenseBuilding["DefenseBuilding\n(Classes/Buildings/DefenseBuilding.cpp)"]
    ProductionBuilding["ProductionBuilding\n(Classes/Buildings/ProductionBuilding.cpp)"]
    StorageBuilding["StorageBuilding\n(Classes/Buildings/StorageBuilding.cpp)"]
    Barracks["Barracks\n(Classes/Buildings/Barracks.cpp)"]

    Unit["Unit\n(Classes/Units/Unit.cpp)"]
    Projectile["Projectile\n(Classes/Projectiles/Projectile.cpp)"]

    %% AppDelegate 初始化
    AppDelegate -->|init| GameManager
    AppDelegate -->|init| ResourceManager
    AppDelegate -->|init| ConfigManager
    AppDelegate -->|init| SaveManager
    AppDelegate -->|launch| MainMenu

    %% 主菜单场景：切换/启动场景
    MainMenu -->|切换场景| BaseScene
    MainMenu -->|切换场景| BattleScene

    %% BaseScene: 管理基地、UI、建筑
    BaseScene -->|create/build| Building
    BaseScene -->|create/build| DefenseBuilding
    BaseScene -->|create/build| ProductionBuilding
    BaseScene -->|create/build| StorageBuilding
    BaseScene -->|create| Barracks
    BaseScene -->|add child UI| UILayer
    BaseScene -->|grid占用/判定| GridMap

    %% BattleScene: 创建敌方建筑、部署单位、战斗流程
    BattleScene -->|create enemy base| DefenseBuilding
    BattleScene -->|create enemy base| ProductionBuilding
    BattleScene -->|create enemy base| StorageBuilding
    BattleScene -->|deploy unit| Unit
    BattleScene -->|ui| UILayer
    BattleScene -->|end battle -> stats/save| GameManager

    %% 管理器与配置
    Building -->|uses config|getConfig: ConfigManager
    Unit -->|uses config|getConfig: ConfigManager
    Barracks -->|uses config|getConfig: ConfigManager
    DefenseBuilding -->|uses config|getConfig: ConfigManager

    %% 资源调用流
    Building -->|consume/pay/refund| ResourceManager
    Barracks -->|consume/train/release| ResourceManager
    ProductionBuilding -->|add produced resources| ResourceManager
    StorageBuilding -->|change max & store| ResourceManager

    %% 防御建筑/单位/投射物交互
    DefenseBuilding -->|fire projectile| Projectile
    Projectile -->|onHit ->| Unit
    Projectile -->|onHit ->| Building
    DefenseBuilding -->|targeting ->| Unit
    Unit -->|attack ->| Building
    Unit -->|attack ->| DefenseBuilding

    %% 寻路/格子
    Unit -->|路径/放置判定| GridMap
    BaseScene -->|grid checks (build)/path| GridMap

    %% 存档/管理/事件
    GameManager -->|save/load| SaveManager
    GameManager -->|control scenes| MainMenu
    BattleScene -->|battle results| GameManager
    BaseScene -->|save or update| GameManager

    %% 回调/事件：建筑摧毁/单位死亡
    Building -.-|onDestroyed callback| BattleScene
    Unit -.-|onDeath| BattleScene
    Barracks -.-|training complete| BaseScene / UILayer

    subgraph "Managers"
      GameManager
      ResourceManager
      ConfigManager
      SaveManager
    end

    subgraph "Scenes"
      MainMenu
      BaseScene
      BattleScene
    end

    subgraph "Gameplay Entities"
      Building
      DefenseBuilding
      ProductionBuilding
      StorageBuilding
      Barracks
      Unit
      Projectile
    end

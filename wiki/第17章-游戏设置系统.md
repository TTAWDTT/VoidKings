# 第17章 游戏设置系统

> **本章目标**：理解游戏设置的实现，包括战斗速度控制、网格显示、音量设置等。

---

## 17.1 GameSettings 设计

### 17.1.1 战斗速度控制

```cpp
// Classes/Utils/GameSettings.h
#ifndef __GAME_SETTINGS_H__
#define __GAME_SETTINGS_H__

namespace GameSettings {
    // 战斗速度
    float getBattleSpeed();
    void setBattleSpeed(float speed);
    void applyBattleSpeed(bool apply = true);
    
    // 网格显示
    bool isGridVisible();
    void setGridVisible(bool visible);
    
    // 音频设置
    bool isBgmMuted();
    void setBgmMuted(bool muted);
    bool isSfxMuted();
    void setSfxMuted(bool muted);
    
    // 加载/保存设置
    void loadSettings();
    void saveSettings();
}

#endif
```

```cpp
// Classes/Utils/GameSettings.cpp
namespace {
    float s_battleSpeed = 1.0f;
    bool s_gridVisible = false;
    bool s_bgmMuted = false;
    bool s_sfxMuted = false;
    
    const char* KEY_BATTLE_SPEED = "battle_speed";
    const char* KEY_GRID_VISIBLE = "grid_visible";
    const char* KEY_BGM_MUTED = "bgm_muted";
    const char* KEY_SFX_MUTED = "sfx_muted";
}

namespace GameSettings {

float getBattleSpeed() {
    return s_battleSpeed;
}

void setBattleSpeed(float speed) {
    // 限制在有效范围
    s_battleSpeed = std::max(0.5f, std::min(2.0f, speed));
}

void applyBattleSpeed(bool apply) {
    float scale = apply ? s_battleSpeed : 1.0f;
    Director::getInstance()->getScheduler()->setTimeScale(scale);
}

} // namespace GameSettings
```

**支持的速度档位**：
- 0.5x：慢速（调试用）
- 1.0x：正常
- 2.0x：加速

### 17.1.2 网格显示切换

```cpp
bool GameSettings::isGridVisible() {
    return s_gridVisible;
}

void GameSettings::setGridVisible(bool visible) {
    s_gridVisible = visible;
}

// 在 GridMap 中使用
void GridMap::updateGridVisibility() {
    if (_gridLineNode) {
        _gridLineNode->setVisible(GameSettings::isGridVisible());
    }
}
```

### 17.1.3 设置持久化

```cpp
void GameSettings::loadSettings() {
    auto ud = UserDefault::getInstance();
    
    s_battleSpeed = ud->getFloatForKey(KEY_BATTLE_SPEED, 1.0f);
    s_gridVisible = ud->getBoolForKey(KEY_GRID_VISIBLE, false);
    s_bgmMuted = ud->getBoolForKey(KEY_BGM_MUTED, false);
    s_sfxMuted = ud->getBoolForKey(KEY_SFX_MUTED, false);
    
    CCLOG("[GameSettings] 设置已加载");
}

void GameSettings::saveSettings() {
    auto ud = UserDefault::getInstance();
    
    ud->setFloatForKey(KEY_BATTLE_SPEED, s_battleSpeed);
    ud->setBoolForKey(KEY_GRID_VISIBLE, s_gridVisible);
    ud->setBoolForKey(KEY_BGM_MUTED, s_bgmMuted);
    ud->setBoolForKey(KEY_SFX_MUTED, s_sfxMuted);
    
    ud->flush();  // 确保写入磁盘
    
    CCLOG("[GameSettings] 设置已保存");
}
```

---

## 17.2 音量控制

### 17.2.1 BGM/SFX 独立开关

```cpp
bool GameSettings::isBgmMuted() {
    return s_bgmMuted;
}

void GameSettings::setBgmMuted(bool muted) {
    s_bgmMuted = muted;
    
    // 立即应用
    if (muted) {
        SimpleAudioEngine::getInstance()->stopBackgroundMusic();
    } else {
        // 恢复播放当前场景的 BGM
        auto* runningScene = Director::getInstance()->getRunningScene();
        if (dynamic_cast<BattleScene*>(runningScene)) {
            AudioManager::playBattleBgm(1);
        } else {
            AudioManager::playMainBgm();
        }
    }
}

bool GameSettings::isSfxMuted() {
    return s_sfxMuted;
}

void GameSettings::setSfxMuted(bool muted) {
    s_sfxMuted = muted;
    
    if (muted) {
        SimpleAudioEngine::getInstance()->stopAllEffects();
    }
}
```

### 17.2.2 状态保存

在游戏退出或切换场景时保存：

```cpp
// AppDelegate.cpp
void AppDelegate::applicationDidEnterBackground() {
    Director::getInstance()->stopAnimation();
    GameSettings::saveSettings();
    AudioManager::pauseAll();
}

// MainMenuScene.cpp
void MainMenuScene::onExitToSystem() {
    GameSettings::saveSettings();
    Director::getInstance()->end();
}
```

---

## 设置面板 UI

```cpp
class SettingsPanel : public Node {
public:
    static SettingsPanel* create();
    bool init() override;
    
    void show();
    void hide();
    
private:
    Node* _panel;
    
    void setupSpeedControl();
    void setupAudioControl();
    void setupGridControl();
};

bool SettingsPanel::init() {
    if (!Node::init()) return false;
    
    auto visibleSize = Director::getInstance()->getVisibleSize();
    
    // 背景遮罩
    auto overlay = LayerColor::create(Color4B(0, 0, 0, 180));
    this->addChild(overlay, 0);
    
    // 面板背景
    _panel = Node::create();
    auto panelBg = LayerColor::create(Color4B(50, 50, 50, 230), 350, 280);
    panelBg->setAnchorPoint(Vec2(0.5f, 0.5f));
    _panel->addChild(panelBg);
    
    // 标题
    auto title = Label::createWithTTF("Settings", "fonts/ScienceGothic.ttf", 22);
    title->setPosition(Vec2(0, 110));
    _panel->addChild(title);
    
    setupSpeedControl();
    setupAudioControl();
    setupGridControl();
    
    // 关闭按钮
    auto closeBtn = createButton("Close", [this]() {
        hide();
    });
    closeBtn->setPosition(Vec2(0, -100));
    _panel->addChild(closeBtn);
    
    _panel->setPosition(visibleSize.width / 2, visibleSize.height / 2);
    this->addChild(_panel, 1);
    
    this->setVisible(false);
    return true;
}

void SettingsPanel::setupSpeedControl() {
    auto label = Label::createWithTTF("Battle Speed:", 
        "fonts/ScienceGothic.ttf", 14);
    label->setPosition(Vec2(-100, 60));
    label->setAnchorPoint(Vec2(0, 0.5f));
    _panel->addChild(label);
    
    // 速度按钮组
    float speeds[] = {0.5f, 1.0f, 2.0f};
    const char* labels[] = {"0.5x", "1x", "2x"};
    
    for (int i = 0; i < 3; ++i) {
        auto btn = Button::create();
        btn->setTitleText(labels[i]);
        btn->setTitleFontSize(12);
        btn->setPosition(Vec2(-30 + i * 60, 60));
        
        float speed = speeds[i];
        btn->addClickEventListener([speed](Ref*) {
            GameSettings::setBattleSpeed(speed);
            AudioManager::playButtonClick();
        });
        
        _panel->addChild(btn);
    }
}

void SettingsPanel::setupAudioControl() {
    // BGM 开关
    auto bgmLabel = Label::createWithTTF("BGM:", 
        "fonts/ScienceGothic.ttf", 14);
    bgmLabel->setPosition(Vec2(-100, 20));
    bgmLabel->setAnchorPoint(Vec2(0, 0.5f));
    _panel->addChild(bgmLabel);
    
    auto bgmToggle = CheckBox::create(
        "UI/checkbox_off.png", "UI/checkbox_on.png");
    bgmToggle->setSelected(!GameSettings::isBgmMuted());
    bgmToggle->setPosition(Vec2(50, 20));
    bgmToggle->addEventListener([](Ref*, CheckBox::EventType type) {
        bool on = (type == CheckBox::EventType::SELECTED);
        GameSettings::setBgmMuted(!on);
    });
    _panel->addChild(bgmToggle);
    
    // SFX 开关
    auto sfxLabel = Label::createWithTTF("SFX:", 
        "fonts/ScienceGothic.ttf", 14);
    sfxLabel->setPosition(Vec2(-100, -20));
    sfxLabel->setAnchorPoint(Vec2(0, 0.5f));
    _panel->addChild(sfxLabel);
    
    auto sfxToggle = CheckBox::create(
        "UI/checkbox_off.png", "UI/checkbox_on.png");
    sfxToggle->setSelected(!GameSettings::isSfxMuted());
    sfxToggle->setPosition(Vec2(50, -20));
    sfxToggle->addEventListener([](Ref*, CheckBox::EventType type) {
        bool on = (type == CheckBox::EventType::SELECTED);
        GameSettings::setSfxMuted(!on);
    });
    _panel->addChild(sfxToggle);
}

void SettingsPanel::setupGridControl() {
    auto label = Label::createWithTTF("Show Grid:", 
        "fonts/ScienceGothic.ttf", 14);
    label->setPosition(Vec2(-100, -60));
    label->setAnchorPoint(Vec2(0, 0.5f));
    _panel->addChild(label);
    
    auto toggle = CheckBox::create(
        "UI/checkbox_off.png", "UI/checkbox_on.png");
    toggle->setSelected(GameSettings::isGridVisible());
    toggle->setPosition(Vec2(50, -60));
    toggle->addEventListener([](Ref*, CheckBox::EventType type) {
        bool on = (type == CheckBox::EventType::SELECTED);
        GameSettings::setGridVisible(on);
    });
    _panel->addChild(toggle);
}

void SettingsPanel::show() {
    this->setVisible(true);
    
    _panel->setScale(0.8f);
    _panel->setOpacity(0);
    _panel->runAction(Spawn::create(
        EaseBackOut::create(ScaleTo::create(0.2f, 1.0f)),
        FadeIn::create(0.15f),
        nullptr
    ));
}

void SettingsPanel::hide() {
    GameSettings::saveSettings();
    
    _panel->runAction(Sequence::create(
        Spawn::create(
            EaseBackIn::create(ScaleTo::create(0.15f, 0.8f)),
            FadeOut::create(0.1f),
            nullptr
        ),
        CallFunc::create([this]() {
            this->setVisible(false);
        }),
        nullptr
    ));
}
```

---

## 战斗中的速度控制

```cpp
// BattleScene.cpp
void BattleScene::setupSpeedControls() {
    // 速度按钮
    auto speedBtn = Button::create();
    speedBtn->setTitleText("1x");
    speedBtn->setPosition(Vec2(visibleSize.width - 60, 
                                visibleSize.height - 30));
    
    speedBtn->addClickEventListener([this, speedBtn](Ref*) {
        float current = GameSettings::getBattleSpeed();
        float next;
        
        if (current < 1.0f) {
            next = 1.0f;
        } else if (current < 2.0f) {
            next = 2.0f;
        } else {
            next = 0.5f;
        }
        
        GameSettings::setBattleSpeed(next);
        GameSettings::applyBattleSpeed(true);
        
        speedBtn->setTitleText(StringUtils::format("%.1fx", next));
        AudioManager::playButtonClick();
    });
    
    _uiLayer->addChild(speedBtn);
}

// 战斗结束时恢复正常速度
void BattleScene::onBattleEnd(bool win) {
    GameSettings::applyBattleSpeed(false);  // 恢复 1x
    // ...
}
```

---

## 本章小结

1. **GameSettings** 命名空间管理所有游戏设置
2. **战斗速度** 通过 `Scheduler::setTimeScale()` 实现
3. **音频开关** 独立控制 BGM 和 SFX
4. **持久化** 使用 `UserDefault` 保存设置
5. **设置面板** 提供用户友好的界面

---

## 练习题

1. 添加音量滑块：0-100% 音量控制
2. 实现语言设置：支持中英文切换
3. 添加画质设置：低/中/高画质

---

**下一章**：[第18章 Android 平台适配](第18章-Android平台适配.md)

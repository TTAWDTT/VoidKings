# 第11章 UI 组件系统

> **本章目标**：掌握 VoidKings 的 UI 设计规范，理解训练面板、商店面板等核心组件的实现。

---

## 11.1 统一字体与按钮风格

### 11.1.1 createBaseLabel() 实现

VoidKings 统一使用 ScienceGothic 字体：

```cpp
// BaseScene.cpp 顶部的工具函数
namespace {
    const char* kBaseFont = "fonts/ScienceGothic.ttf";
    
    Label* createBaseLabel(const std::string& text, float fontSize) {
        auto label = Label::createWithTTF(text, kBaseFont, fontSize);
        if (!label) {
            // 字体加载失败，使用系统字体
            label = Label::create();
            label->setString(text);
            label->setSystemFontSize(fontSize);
            CCLOG("[UI] 字体加载失败，使用系统字体");
        }
        return label;
    }
}
```

### 11.1.2 字体加载失败回退

```cpp
Label* createSafeLabel(const std::string& text, float size) {
    // 尝试加载自定义字体
    auto label = Label::createWithTTF(text, kBaseFont, size);
    
    if (!label) {
        // 回退到系统字体
        label = Label::createWithSystemFont(text, "Arial", size);
    }
    
    if (!label) {
        // 最后手段：创建空 Label
        label = Label::create();
        label->setString(text);
    }
    
    return label;
}
```

### 11.1.3 按钮样式配置

```cpp
// 按钮颜色配置
const Color4B kNormalBtnColor(44, 110, 160, 220);
const Color4B kPressedBtnColor(30, 85, 130, 240);
const Color4B kDisabledBtnColor(100, 100, 100, 180);

Button* createStyledButton(const std::string& title, 
                            float fontSize,
                            const Size& size) {
    auto button = Button::create();
    button->setScale9Enabled(true);
    button->setContentSize(size);
    button->setTitleText(title);
    button->setTitleFontName(kBaseFont);
    button->setTitleFontSize(fontSize);
    button->setTitleColor(Color3B(245, 245, 245));
    
    // 按压效果
    button->setPressedActionEnabled(true);
    button->setZoomScale(0.06f);
    button->setSwallowTouches(true);
    
    // 背景层
    auto bg = LayerColor::create(kNormalBtnColor, size.width, size.height);
    bg->setAnchorPoint(Vec2(0.5f, 0.5f));
    bg->setIgnoreAnchorPointForPosition(false);
    bg->setPosition(size.width * 0.5f, size.height * 0.5f);
    bg->setName("btnBg");
    button->addChild(bg, -1);
    
    return button;
}
```

### 11.1.4 按压反馈动画

```cpp
void setupButtonFeedback(Button* button, 
                          const Color4B& normalColor,
                          const Color4B& pressedColor) {
    auto bg = button->getChildByName("btnBg");
    
    button->addTouchEventListener([bg, normalColor, pressedColor]
        (Ref*, Widget::TouchEventType type) {
        if (!bg) return;
        
        auto* layer = dynamic_cast<LayerColor*>(bg);
        if (!layer) return;
        
        switch (type) {
            case Widget::TouchEventType::BEGAN:
                layer->setColor(Color3B(pressedColor.r, 
                                        pressedColor.g, 
                                        pressedColor.b));
                break;
                
            case Widget::TouchEventType::ENDED:
            case Widget::TouchEventType::CANCELED:
                layer->setColor(Color3B(normalColor.r, 
                                        normalColor.g, 
                                        normalColor.b));
                break;
        }
    });
}
```

---

## 11.2 TrainPanel 训练面板

### 11.2.1 面板尺寸与布局配置

```cpp
// Classes/UI/TrainPanel.h
namespace TrainPanelConfig {
    constexpr float PANEL_WIDTH_RATIO = 0.85f;
    constexpr float PANEL_HEIGHT_RATIO = 0.8f;
    constexpr float CARD_WIDTH = 120.0f;
    constexpr float CARD_HEIGHT = 180.0f;
    constexpr float CARD_SPACING = 16.0f;
    constexpr float DETAIL_PANEL_WIDTH = 300.0f;
}

class TrainPanel : public Node {
public:
    static TrainPanel* create();
    bool init() override;
    
    void show();
    void hide();
    void refresh();
    
    void setOnClose(std::function<void()> callback);
    
private:
    Node* _background;
    Node* _panel;
    ScrollView* _scrollView;
    Node* _detailPanel;
    
    int _selectedUnitId = -1;
    std::function<void()> _onClose;
    
    Node* createUnitCard(int unitId);
    void updateDetailPanel(int unitId);
    void onRecruitClicked();
    void onUpgradeClicked();
};
```

### 11.2.2 兵种卡片创建

```cpp
Node* TrainPanel::createUnitCard(int unitId) {
    auto card = Node::create();
    card->setContentSize(Size(CARD_WIDTH, CARD_HEIGHT));
    
    // 卡片背景
    auto bg = LayerColor::create(Color4B(50, 50, 50, 200), 
                                  CARD_WIDTH, CARD_HEIGHT);
    card->addChild(bg, 0);
    
    // 边框
    auto border = DrawNode::create();
    border->drawRect(Vec2::ZERO, Vec2(CARD_WIDTH, CARD_HEIGHT), 
                     Color4F::WHITE);
    card->addChild(border, 1);
    
    // 兵种配置
    auto* config = UnitManager::getInstance()->getConfig(unitId);
    if (!config) return card;
    
    // 兵种图标（待机动画）
    auto icon = createUnitIdleIcon(unitId, 60.0f);
    if (icon) {
        icon->setPosition(Vec2(CARD_WIDTH / 2, CARD_HEIGHT - 50));
        card->addChild(icon, 2);
    }
    
    // 名称
    auto nameLabel = createBaseLabel(config->name, 12);
    nameLabel->setPosition(Vec2(CARD_WIDTH / 2, CARD_HEIGHT - 90));
    card->addChild(nameLabel, 2);
    
    // 等级
    int level = UnitManager::getInstance()->getUnitLevel(unitId);
    auto levelLabel = createBaseLabel(
        StringUtils::format("Lv.%d", level + 1), 10);
    levelLabel->setPosition(Vec2(CARD_WIDTH / 2, CARD_HEIGHT - 110));
    levelLabel->setColor(Color3B::YELLOW);
    card->addChild(levelLabel, 2);
    
    // 已训练数量
    int count = UnitManager::getInstance()->getTrainedCount(unitId);
    auto countLabel = createBaseLabel(
        StringUtils::format("x%d", count), 14);
    countLabel->setPosition(Vec2(CARD_WIDTH / 2, 30));
    countLabel->setName("countLabel");
    card->addChild(countLabel, 2);
    
    // 点击事件
    auto touchBtn = Button::create();
    touchBtn->setContentSize(Size(CARD_WIDTH, CARD_HEIGHT));
    touchBtn->setScale9Enabled(true);
    touchBtn->addClickEventListener([this, unitId](Ref*) {
        _selectedUnitId = unitId;
        updateDetailPanel(unitId);
        AudioManager::playButtonClick();
    });
    card->addChild(touchBtn, 3);
    
    card->setTag(unitId);
    return card;
}
```

### 11.2.3 待机动画精灵生成

```cpp
Sprite* TrainPanel::createUnitIdleIcon(int unitId, float targetSize) {
    auto* config = UnitManager::getInstance()->getConfig(unitId);
    if (!config) return nullptr;
    
    // 获取基础精灵名
    std::string baseName = config->spriteBaseName;
    
    // 创建精灵
    auto sprite = Sprite::create(config->spriteFrameName);
    if (!sprite) return nullptr;
    
    // 缩放到目标尺寸
    Size size = sprite->getContentSize();
    if (size.width > 0 && size.height > 0) {
        float scale = targetSize / std::max(size.width, size.height);
        sprite->setScale(scale);
    }
    
    // 播放待机动画
    auto anim = AnimationUtils::buildAnimationFromFrames(
        baseName, config->anim_idle, 
        config->anim_idle_frames, config->anim_idle_delay, true);
    
    if (anim && anim->getFrames().size() > 1) {
        sprite->runAction(RepeatForever::create(Animate::create(anim)));
    }
    
    return sprite;
}
```

### 11.2.4 招募/升级按钮逻辑

```cpp
void TrainPanel::onRecruitClicked() {
    if (_selectedUnitId < 0) return;
    
    bool success = UnitManager::getInstance()->trainUnit(_selectedUnitId);
    
    if (success) {
        AudioManager::playMoneyGet();
        updateDetailPanel(_selectedUnitId);
        refreshCardCount(_selectedUnitId);
    } else {
        AudioManager::playButtonCancel();
        // 显示资源不足提示
    }
}

void TrainPanel::onUpgradeClicked() {
    if (_selectedUnitId < 0) return;
    
    bool success = UnitManager::getInstance()->upgradeUnit(_selectedUnitId);
    
    if (success) {
        AudioManager::playMoneyGet();
        updateDetailPanel(_selectedUnitId);
        refreshAllCards();  // 等级变化，刷新所有卡片
    } else {
        AudioManager::playButtonCancel();
    }
}
```

### 11.2.5 详情面板更新

```cpp
void TrainPanel::updateDetailPanel(int unitId) {
    // 清空现有内容
    _detailPanel->removeAllChildren();
    
    auto* config = UnitManager::getInstance()->getConfig(unitId);
    if (!config) return;
    
    int level = UnitManager::getInstance()->getUnitLevel(unitId);
    
    // 标题
    auto title = createBaseLabel(config->name, 20);
    title->setPosition(Vec2(DETAIL_PANEL_WIDTH / 2, 280));
    _detailPanel->addChild(title);
    
    // 属性列表
    float hp = level < config->HP.size() ? config->HP[level] : 0;
    float atk = level < config->ATK.size() ? config->ATK[level] : 0;
    float speed = level < config->SPEED.size() ? config->SPEED[level] : 0;
    
    std::string stats = StringUtils::format(
        "Level: %d / %d\n"
        "HP: %.0f\n"
        "ATK: %.0f\n"
        "Speed: %.0f",
        level + 1, config->MAXLEVEL + 1, hp, atk, speed
    );
    
    auto statsLabel = createBaseLabel(stats, 14);
    statsLabel->setAlignment(TextHAlignment::LEFT);
    statsLabel->setPosition(Vec2(20, 180));
    statsLabel->setAnchorPoint(Vec2(0, 0.5f));
    _detailPanel->addChild(statsLabel);
    
    // 招募按钮
    int cost = resolveRecruitCost(config);
    auto recruitBtn = createStyledButton(
        StringUtils::format("Recruit (%d G)", cost),
        14, Size(120, 36));
    recruitBtn->setPosition(Vec2(DETAIL_PANEL_WIDTH / 2, 80));
    recruitBtn->addClickEventListener([this](Ref*) {
        onRecruitClicked();
    });
    _detailPanel->addChild(recruitBtn);
    
    // 升级按钮
    if (level < config->MAXLEVEL) {
        int upgradeCost = 50 * (level + 1);
        auto upgradeBtn = createStyledButton(
            StringUtils::format("Upgrade (%d D)", upgradeCost),
            14, Size(120, 36));
        upgradeBtn->setPosition(Vec2(DETAIL_PANEL_WIDTH / 2, 35));
        upgradeBtn->addClickEventListener([this](Ref*) {
            onUpgradeClicked();
        });
        _detailPanel->addChild(upgradeBtn);
    }
}
```

---

## 11.3 ScrollView 滚动实现

### 11.3.1 内容容器尺寸计算

```cpp
void TrainPanel::setupScrollView() {
    auto visibleSize = Director::getInstance()->getVisibleSize();
    float scrollWidth = visibleSize.width * PANEL_WIDTH_RATIO - 
                        DETAIL_PANEL_WIDTH - 40;
    float scrollHeight = visibleSize.height * PANEL_HEIGHT_RATIO - 80;
    
    _scrollView = ScrollView::create();
    _scrollView->setContentSize(Size(scrollWidth, scrollHeight));
    _scrollView->setDirection(ScrollView::Direction::HORIZONTAL);
    _scrollView->setBounceEnabled(true);
    _scrollView->setScrollBarEnabled(true);
    
    // 内容容器
    auto container = Node::create();
    _scrollView->setInnerContainer(container);
    
    _panel->addChild(_scrollView);
}

void TrainPanel::layoutCards() {
    auto* container = _scrollView->getInnerContainer();
    container->removeAllChildren();
    
    auto unitIds = UnitManager::getInstance()->getAllUnitIds();
    int count = static_cast<int>(unitIds.size());
    
    // 计算内容宽度
    float contentWidth = count * (CARD_WIDTH + CARD_SPACING) - CARD_SPACING;
    contentWidth = std::max(contentWidth, _scrollView->getContentSize().width);
    
    container->setContentSize(Size(contentWidth, CARD_HEIGHT + 20));
    _scrollView->setInnerContainerSize(container->getContentSize());
    
    // 放置卡片
    for (int i = 0; i < count; ++i) {
        auto card = createUnitCard(unitIds[i]);
        float x = i * (CARD_WIDTH + CARD_SPACING) + CARD_WIDTH / 2;
        card->setPosition(Vec2(x, CARD_HEIGHT / 2 + 10));
        container->addChild(card);
    }
}
```

---

## 11.4 显示/隐藏动画

### 11.4.1 背景淡入淡出

```cpp
void TrainPanel::show() {
    this->setVisible(true);
    
    // 背景淡入
    _background->setOpacity(0);
    _background->runAction(FadeTo::create(0.2f, 180));
    
    // 面板弹出
    _panel->setScale(0.8f);
    _panel->setOpacity(0);
    _panel->runAction(Spawn::create(
        EaseBackOut::create(ScaleTo::create(0.25f, 1.0f)),
        FadeIn::create(0.2f),
        nullptr
    ));
    
    // 刷新数据
    refresh();
}
```

### 11.4.2 面板弹出缩放

```cpp
void TrainPanel::hide() {
    // 面板收缩
    _panel->runAction(Spawn::create(
        EaseBackIn::create(ScaleTo::create(0.2f, 0.8f)),
        FadeOut::create(0.15f),
        nullptr
    ));
    
    // 背景淡出
    _background->runAction(Sequence::create(
        FadeOut::create(0.2f),
        CallFunc::create([this]() {
            this->setVisible(false);
            if (_onClose) _onClose();
        }),
        nullptr
    ));
}
```

### 11.4.3 EaseBackOut/EaseBackIn

```cpp
// EaseBackOut: 先超过目标再回弹（弹出效果）
auto easeOut = EaseBackOut::create(ScaleTo::create(0.25f, 1.0f));
// 效果：0.8 → 1.05 → 1.0

// EaseBackIn: 先后退再加速（收起效果）
auto easeIn = EaseBackIn::create(ScaleTo::create(0.2f, 0.8f));
// 效果：1.0 → 0.95 → 0.8
```

---

## 本章小结

1. **统一字体** 确保视觉一致性
2. **按钮组件** 使用 LayerColor 作为背景，避免纹理依赖
3. **TrainPanel** 使用 ScrollView 支持横向滚动
4. **详情面板** 动态显示选中兵种的属性
5. **动画效果** 提升用户体验

---

## 练习题

1. 添加搜索功能：按名称过滤兵种
2. 实现批量招募：一次训练多个单位
3. 添加兵种对比功能：同时查看两个兵种属性

---

**下一章**：[第12章 动画系统深入讲解](第12章-动画系统深入讲解.md)

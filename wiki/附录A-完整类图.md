# 附录A：完整类图

> **本附录**：展示 VoidKings 项目的核心类关系。

---

## 核心类关系图

```
┌─────────────────────────────────────────────────────────────────────┐
│                          cocos2d::Ref                                │
│                               ↑                                      │
│                          cocos2d::Node                               │
│                               ↑                                      │
├───────────────────────────────┼─────────────────────────────────────┤
│                               │                                      │
│  ┌────────────────────────────┼────────────────────────────────┐    │
│  │                            │                                │    │
│  ▼                            ▼                                ▼    │
│ Scene                       Sprite                           Node   │
│   ↑                           ↑                                ↑    │
│ MainMenuScene              各种精灵                                  │
│ BaseScene                                                           │
│ BattleScene                                                         │
│ LevelSelectScene                                                    │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 建筑类继承结构

```
cocos2d::Node
       ↑
       │
┌──────┴──────────────────────────────────────────────────────┐
│                                                              │
│  DefenceBuilding              ProductionBuilding             │
│       ↑                             ↑                        │
│       │                             │                        │
│  ┌────┴────┐                  ┌─────┴─────┐                 │
│  │         │                  │           │                 │
│ ArrowTower │              MainBase   GoldMine               │
│ BoomTower  │              Barracks   ElixirCollector        │
│ MagicTower │                                                 │
│ FireTower  │                                                 │
│ IceTower   │                                                 │
│            │                                                 │
└────────────┴─────────────────────────────────────────────────┘
       ↑
       │
   TrapBase
       ↑
  ┌────┴────┐
  │         │
SpikeTrap SnapTrap


StorageBuilding
       ↑
       │
  GoldStorage
  ElixirStorage
```

---

## 士兵类继承结构

```
cocos2d::Node
       ↑
       │
    Soldier ◄───── 享元模式 ─────► UnitConfig
       ↑
       │
  ┌────┴────────────────────────────┐
  │              │                  │
Spearman     Archer             Healer
Giant        Wizard             Tank
Dragon       Bomber
```

---

## 管理器类结构

```
┌─────────────────────────────────────────────────────────────────┐
│                         单例管理器                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │     Core     │  │BuildingManager│  │ UnitManager │          │
│  ├──────────────┤  ├──────────────┤  ├──────────────┤          │
│  │ 资源管理     │  │ 配置加载     │  │ 配置加载     │          │
│  │ 等级管理     │  │ 建筑创建     │  │ 训练队列     │          │
│  │ 星级记录     │  │ 工厂方法     │  │ 等级管理     │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐      │
│  │ SaveManager  │  │ReplayManager │  │BattleShareManager│      │
│  ├──────────────┤  ├──────────────┤  ├──────────────────┤      │
│  │ 槽位存档     │  │ 录制回放     │  │ 快照导出/导入    │      │
│  │ JSON序列化   │  │ 播放回放     │  │ 异步攻防         │      │
│  │ 加载/保存    │  │ 序列化       │  │                  │      │
│  └──────────────┘  └──────────────┘  └──────────────────┘      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 场景类层次

```
cocos2d::Scene
       ↑
       │
  ┌────┴────────────────────────────────────────────┐
  │              │              │                   │
MainMenuScene  BaseScene   BattleScene        LevelSelectScene
                  │              │
                  │              │
            ┌─────┴─────┐  ┌────┴─────────────────────┐
            │           │  │                          │
       PlacementManager │  │  BattleMode::Attack      │
       TrainPanel       │  │  BattleMode::Defense     │
       BuildShopPanel   │  │  ReplayMode              │
       SettingsPanel    │  │  SnapshotMode            │
                        │  │                          │
                        │  └──────────────────────────┘
                        │
                   GridMap
```

---

## UI 组件关系

```
cocos2d::Node
       ↑
       │
  ┌────┴────────────────────────────────────────────┐
  │              │              │                   │
TrainPanel   IDCardPanel   SettingsPanel     AsyncPanel
    │
    ├── ScrollView (兵种列表)
    │       └── UnitCard × N
    │
    └── DetailPanel (详情)
            ├── StatsLabel
            ├── RecruitButton
            └── UpgradeButton
```

---

## 数据流图

```
┌─────────────────────────────────────────────────────────────────┐
│                          数据流                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  JSON 配置文件                                                   │
│  ├── buildings_config.json ─────► BuildingManager._configs      │
│  └── units_config.json ─────────► UnitManager._configs          │
│                                                                  │
│                          ↓                                       │
│                                                                  │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │   Core      │◄──►│ SaveManager │◄──►│ local-storage│         │
│  │ 运行时数据  │    │  序列化     │    │  SQLite     │         │
│  └──────┬──────┘    └─────────────┘    └─────────────┘         │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────┐    ┌─────────────┐                             │
│  │ BattleScene │◄──►│ReplayManager│                             │
│  │ 战斗逻辑    │    │ 回放数据    │                             │
│  └──────┬──────┘    └──────┬──────┘                             │
│         │                  │                                     │
│         ▼                  ▼                                     │
│  ┌─────────────────────────────────┐                            │
│  │       BattleShareManager        │                            │
│  │       快照/回放文件交换          │                            │
│  └─────────────────────────────────┘                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 事件系统

```
┌─────────────────────────────────────────────────────────────────┐
│                        事件分发                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  EventDispatcher                                                 │
│         │                                                        │
│         ├── EventListenerTouchOneByOne                          │
│         │       └── BattleScene::onTouchBegan                   │
│         │       └── PlacementManager::onTouchMoved              │
│         │                                                        │
│         ├── EventListenerKeyboard                               │
│         │       └── 暂停控制                                     │
│         │                                                        │
│         ├── EventListenerMouse                                  │
│         │       └── BattleScene::onMouseMove (悬浮信息)          │
│         │                                                        │
│         └── EventListenerCustom                                 │
│                 └── "resource_changed"                          │
│                 └── "building_destroyed"                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 本附录小结

- **核心继承**：大多数游戏对象继承自 `cocos2d::Node`
- **单例管理器**：管理全局状态和配置
- **享元模式**：配置数据共享，节省内存
- **事件系统**：解耦输入处理和游戏逻辑
